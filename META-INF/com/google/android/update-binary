#!/sbin/sh

##########################################################################################
#
# Magisk Module Installer Script
#
##########################################################################################

OUTFD=$2
ZIPFILE=$3

ui_print() {
  echo -e "ui_print $1\nui_print" >> /proc/self/fd/$OUTFD
}

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

# Detect Magisk
is_mounted() {
  grep -q " $(readlink -f $1) " /proc/mounts 2>/dev/null
  return $?
}

TMPDIR=/dev/tmp
PERSISTDIR=/sbin/.magisk/mirror/persist

rm -rf $TMPDIR 2>/dev/null
mkdir -p $TMPDIR

# Check Magisk version
[ -z $MAGISK_VER_CODE ] || require_new_magisk

# Extract module files
ui_print "- Extracting module files"
unzip -o "$ZIPFILE" -d $TMPDIR >&2

# Copy files to module directory
MODPATH=/data/adb/modules/app.redirector
rm -rf $MODPATH 2>/dev/null
mkdir -p $MODPATH

ui_print "- Installing App Redirector"
cp -af $TMPDIR/* $MODPATH/
rm -rf $MODPATH/META-INF

# Set permissions
ui_print "- Setting permissions"
set_perm_recursive $MODPATH 0 0 0755 0644
[ -f $MODPATH/service.sh ] && chmod 0755 $MODPATH/service.sh
[ -f $MODPATH/uninstall.sh ] && chmod 0755 $MODPATH/uninstall.sh

ui_print " "
ui_print "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
ui_print "â•‘                                                   â•‘"
ui_print "â•‘        ğŸ”€  APP REDIRECTOR  ğŸ”€                    â•‘"
ui_print "â•‘                                                   â•‘"
ui_print "â•‘   ğŸ›¡ï¸ Security Research & Education Tool ğŸ›¡ï¸       â•‘"
ui_print "â•‘                                                   â•‘"
ui_print "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
ui_print " "
ui_print "âœ… Installation complete!"
ui_print "ğŸš€ Module will start on next reboot"
ui_print " "
ui_print "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
ui_print "â”‚  ğŸ“ SETUP INSTRUCTIONS:                          â”‚"
ui_print "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
ui_print "â”‚                                                   â”‚"
ui_print "â”‚  1ï¸âƒ£  Edit redirect list:                         â”‚"
ui_print "â”‚     /data/adb/app_redirect_list.txt              â”‚"
ui_print "â”‚                                                   â”‚"
ui_print "â”‚  2ï¸âƒ£  Format: source.pkg=target.pkg               â”‚"
ui_print "â”‚                                                   â”‚"
ui_print "â”‚  3ï¸âƒ£  Changes apply immediately (no reboot)       â”‚"
ui_print "â”‚                                                   â”‚"
ui_print "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
ui_print "â”‚  ğŸ’¡ Find package names:                          â”‚"
ui_print "â”‚     adb shell pm list packages | grep <name>     â”‚"
ui_print "â”‚                                                   â”‚"
ui_print "â”‚  ğŸ“Š View logs:                                   â”‚"
ui_print "â”‚     adb logcat -s MagiskAppWatcher               â”‚"
ui_print "â”‚                                                   â”‚"
ui_print "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
ui_print " "
ui_print "âš ï¸  FOR EDUCATIONAL PURPOSES ONLY"
ui_print "ğŸ”¥ Author: _Hi1uTr3n_"
ui_print " "

rm -rf $TMPDIR
exit 0
